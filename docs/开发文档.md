# 学生请假管理系统 - 开发文档

## 1. 项目概述

### 1.1 项目背景
为学校开发一套完整的学生请假管理系统，实现教师申请请假、管理员审核、自动统计请假天数和退费金额等功能。

### 1.2 目标用户
- 学校教师：发起请假申请
- 管理员：审核请假、管理基础数据、查看统计报表
- 班主任：查看本班学生请假情况

### 1.3 部署环境
- 单学校单机部署

## 2. 技术栈

| 技术类型 | 技术选型 | 说明 |
|---------|---------|------|
| 前端框架 | Next.js 15 (App Router) | React 服务端渲染框架 |
| 编程语言 | TypeScript 5 | 静态类型检查 |
| UI 组件库 | shadcn/ui | 基于 Radix UI 的组件库 |
| 样式方案 | Tailwind CSS v4 | 原子化 CSS 框架 |
| 数据库 | PostgreSQL | 关系型数据库 |
| 数据库操作 | Drizzle ORM | 类型安全的 ORM |
| Excel 处理 | xlsx | 导入导出功能 |
| 表单处理 | react-hook-form + zod | 表单验证 |
| 日期处理 | date-fns | 日期操作工具 |

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         表现层 (UI)                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 登录页面  │  │ 管理后台  │  │ 教师工作台│  │ 班主任端  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
├─────────────────────────────────────────────────────────────┤
│                       业务逻辑层 (API)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 用户认证  │  │ 请假管理  │  │ 退费计算  │  │ 数据导入  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
├─────────────────────────────────────────────────────────────┤
│                       数据访问层 (DAL)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 用户管理  │  │ 学生管理  │  │ 请假记录  │  │ 系统配置  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
├─────────────────────────────────────────────────────────────┤
│                       数据存储层 (SQLite)                     │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 目录结构

```
student_leave/
├── app/
│   ├── (auth)/
│   │   └── login/
│   │       └── page.tsx                 # 登录页面
│   ├── (dashboard)/
│   │   ├── admin/                       # 管理员端
│   │   │   ├── dashboard/
│   │   │   ├── users/
│   │   │   ├── students/
│   │   │   ├── leaves/
│   │   │   ├── semesters/
│   │   │   ├── grades/
│   │   │   ├── classes/
│   │   │   ├── refunds/
│   │   │   ├── settings/
│   │   │   └── backup/
│   │   ├── teacher/                     # 教师端
│   │   │   ├── dashboard/
│   │   │   ├── leaves/
│   │   │   └── students/
│   │   └── class-teacher/               # 班主任端
│   │       ├── dashboard/
│   │       └── students/
│   ├── api/                             # API 路由
│   │   ├── auth/
│   │   ├── users/
│   │   ├── students/
│   │   ├── leaves/
│   │   ├── refunds/
│   │   ├── import/
│   │   ├── export/
│   │   └── backup/
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   ├── ui/                              # shadcn/ui 组件
│   ├── auth/
│   ├── admin/
│   ├── teacher/
│   ├── shared/
│   └── layouts/
├── lib/
│   ├── db/                              # 数据库操作
│   │   ├── schema.ts                    # 数据库模式
│   │   ├── migrations/                  # 数据库迁移
│   │   └── seeds/                       # 初始数据
│   ├── api/                             # API 服务层
│   ├── hooks/                           # 自定义 Hooks
│   ├── utils/                           # 工具函数
│   └── constants/                       # 常量定义
├── types/                               # TypeScript 类型定义
├── public/                              # 静态资源
├── middleware.ts                        # 中间件（权限控制）
├── next.config.ts
├── tailwind.config.ts
├── tsconfig.json
└── package.json
```

## 4. 数据库设计

### 4.1 数据表设计

#### 4.1.1 用户表 (users)

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    real_name VARCHAR(50) NOT NULL,
    role VARCHAR(20) NOT NULL,           -- admin, teacher, class_teacher
    phone VARCHAR(20),
    email VARCHAR(100),
    is_active BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.2 学期表 (semesters)

```sql
CREATE TABLE semesters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) NOT NULL,           -- 如 "2024-2025第一学期"
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    school_days INTEGER NOT NULL,        -- 在校天数
    is_current BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.3 年级表 (grades)

```sql
CREATE TABLE grades (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(20) NOT NULL,           -- 如 "一年级"、"二年级"
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.4 班级表 (classes)

```sql
CREATE TABLE classes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    grade_id INTEGER NOT NULL,
    name VARCHAR(20) NOT NULL,           -- 如 "1班"、"2班"
    class_teacher_id INTEGER,            -- 班主任ID
    meal_fee DECIMAL(10,2) NOT NULL,     -- 伙食费标准（元/学期）
    student_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (grade_id) REFERENCES grades(id),
    FOREIGN KEY (class_teacher_id) REFERENCES users(id)
);
```

#### 4.1.5 学生表 (students)

```sql
CREATE TABLE students (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_no VARCHAR(30) UNIQUE NOT NULL,  -- 学号
    name VARCHAR(50) NOT NULL,
    gender VARCHAR(10),                     -- 男/女
    class_id INTEGER NOT NULL,
    birth_date DATE,
    parent_name VARCHAR(50),
    parent_phone VARCHAR(20),
    address TEXT,
    is_nutrition_meal BOOLEAN DEFAULT 0,    -- 是否享受营养餐
    enrollment_date DATE,
    is_active BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (class_id) REFERENCES classes(id)
);
```

#### 4.1.6 请假记录表 (leave_records)

```sql
CREATE TABLE leave_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id INTEGER NOT NULL,
    semester_id INTEGER NOT NULL,
    applicant_id INTEGER NOT NULL,          -- 申请人ID（教师）
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    leave_days INTEGER NOT NULL,            -- 请假天数
    reason TEXT NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',   -- pending, approved, rejected
    reviewer_id INTEGER,                    -- 审核人ID
    review_time DATETIME,
    review_remark TEXT,
    is_refund BOOLEAN DEFAULT 1,            -- 是否退费
    refund_amount DECIMAL(10,2),            -- 退费金额
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (semester_id) REFERENCES semesters(id),
    FOREIGN KEY (applicant_id) REFERENCES users(id),
    FOREIGN KEY (reviewer_id) REFERENCES users(id)
);
```

#### 4.1.7 系统配置表 (system_config)

```sql
CREATE TABLE system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(50) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.8 操作日志表 (operation_logs)

```sql
CREATE TABLE operation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    action VARCHAR(50) NOT NULL,
    module VARCHAR(50) NOT NULL,
    description TEXT,
    ip_address VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.2 ER 图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   users     │     │   grades    │     │ semesters   │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ id (PK)     │     │ id (PK)     │     │ id (PK)     │
│ username    │     │ name        │     │ name        │
│ password... │     │ sort_order  │     │ start_date  │
│ role        │     └──────┬──────┘     │ end_date    │
│ ...         │            │            │ school_days │
└──────┬──────┘            │            └──────┬──────┘
       │                  │                   │
       │         ┌────────▼────────┐           │
       │         │     classes     │◄──────────┘
       │         ├─────────────────┤
       │         │ id (PK)         │
       │         │ grade_id (FK)   │
       │         │ class_teacher...│──┐
       │         │ meal_fee        │  │
       │         └────────┬────────┘  │
       │                  │           │
       │         ┌────────▼────────┐  │
       │         │    students     │  │
       │         ├─────────────────┤  │
       └─────────│ class_teacher...│──┘
                 │ id (PK)         │
                 │ class_id (FK)   │
                 │ is_nutrition... │
                 └────────┬────────┘
                          │
                ┌─────────▼─────────┐
                │   leave_records   │
                ├───────────────────┤
                │ id (PK)           │
                │ student_id (FK)   │
                │ semester_id (FK)  │
                │ applicant_id (FK) │┐
                │ reviewer_id (FK)  ││
                │ status            ││
                │ refund_amount     ││
                └───────────────────┘│
                                     │
                   ┌─────────────────┘
                   │
        ┌──────────▼──────────┐
        │ operation_logs      │
        ├─────────────────────┤
        │ id (PK)             │
        │ user_id (FK)        │
        │ action              │
        │ ...                 │
        └─────────────────────┘
```

## 5. 功能模块设计

### 5.1 用户权限管理

#### 5.1.1 角色定义

| 角色 | 权限描述 |
|-----|---------|
| **超级管理员** | 所有功能权限 |
| **管理员** | 用户管理、基础设置、请假审核、数据导入导出、系统备份 |
| **教师** | 学生请假申请、查看自己的请假记录 |
| **班主任** | 查看本班学生信息、查看本班请假记录 |

#### 5.1.2 功能清单
- 用户登录/登出
- 用户列表（增删改查）
- 角色权限分配
- 密码修改

### 5.2 基础信息设置

#### 5.2.1 学期管理
- 学期列表（增删改查）
- 设置当前学期
- 设置在校天数

#### 5.2.2 年级管理
- 年级列表（增删改查）
- 年级排序

#### 5.2.3 班级管理
- 班级列表（增删改查）
- 绑定班主任
- 设置伙食费标准
- 班级学生统计

### 5.3 学生档案管理

#### 5.3.1 学生信息
- 学生列表（分页、搜索、筛选）
- 学生信息（增删改查）
- 批量导入学生
- 导出学生信息

#### 5.3.2 学生详情
- 基本信息
- 班级信息
- 营养餐资格
- 请假历史记录
- 退费统计

### 5.4 请假申请与审核流程

#### 5.4.1 请假申请（教师）
- 选择学生
- 填写请假时间（开始日期、结束日期）
- 填写请假原因
- 自动计算请假天数
- 自动判断是否可退费（营养餐学生不可退费）
- 提交申请

#### 5.4.2 请假审核（管理员）
- 待审核列表
- 查看请假详情
- 批准/拒绝
- 填写审核备注
- 自动生成退费金额

#### 5.4.3 请假记录查询
- 全部请假记录
- 按学生/班级/学期筛选
- 按状态筛选
- 导出请假记录

### 5.5 营养餐资格管理

- 标记学生是否享受营养餐
- 营养餐学生请假不退费
- 营养餐学生名单导出

### 5.6 退费管理

#### 5.6.1 退费计算规则
```
每日退费金额 = 班级伙食费标准 / 学期在校天数
退费金额 = 请假天数 × 每日退费金额
```

#### 5.6.2 退费清单
- 按学期生成退费清单
- 按班级分组统计
- 显示每名学生的退费明细
- 导出退费清单（Excel）

### 5.7 数据导入导出

#### 5.7.1 导入功能
- 批量导入学生信息（Excel模板）
- 批量导入请假记录

#### 5.7.2 导出功能
- 导出学生信息
- 导出请假记录
- 导出退费清单
- 导出统计报表

### 5.8 数据备份

- 手动备份数据库
- 自动定时备份（可配置）
- 备份文件下载
- 备份恢复

### 5.9 数据统计

- 学生统计（按班级）
- 请假统计（按时间、班级）
- 退费统计（按学期）
- 图表展示

## 6. API 设计

### 6.1 认证相关

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/auth/login` | POST | 用户登录 |
| `/api/auth/logout` | POST | 用户登出 |
| `/api/auth/me` | GET | 获取当前用户信息 |
| `/api/auth/change-password` | POST | 修改密码 |

### 6.2 用户管理

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/users` | GET | 用户列表 |
| `/api/users` | POST | 创建用户 |
| `/api/users/[id]` | GET | 用户详情 |
| `/api/users/[id]` | PUT | 更新用户 |
| `/api/users/[id]` | DELETE | 删除用户 |

### 6.3 学生管理

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/students` | GET | 学生列表 |
| `/api/students` | POST | 创建学生 |
| `/api/students/[id]` | GET | 学生详情 |
| `/api/students/[id]` | PUT | 更新学生 |
| `/api/students/[id]` | DELETE | 删除学生 |
| `/api/students/import` | POST | 导入学生 |
| `/api/students/export` | GET | 导出学生 |

### 6.4 请假管理

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/leaves` | GET | 请假记录列表 |
| `/api/leaves` | POST | 创建请假申请 |
| `/api/leaves/[id]` | GET | 请假详情 |
| `/api/leaves/[id]/approve` | POST | 批准请假 |
| `/api/leaves/[id]/reject` | POST | 拒绝请假 |
| `/api/leaves/export` | GET | 导出请假记录 |

### 6.5 退费管理

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/refunds/summary` | GET | 退费汇总 |
| `/api/refunds/export` | GET | 导出退费清单 |

### 6.6 费用配置管理

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/fee-configs` | GET | 费用配置列表 |
| `/api/fee-configs` | POST | 创建费用配置 |
| `/api/fee-configs/[id]` | GET | 费用配置详情 |
| `/api/fee-configs/[id]` | PUT | 更新费用配置 |
| `/api/fee-configs/[id]` | DELETE | 删除费用配置 |
| `/api/fee-configs/import` | POST | 导入费用配置 |
| `/api/fee-configs/export` | GET | 导出费用配置 |

### 6.7 仪表盘统计

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/dashboard/stats/*` | GET | 管理员仪表盘统计 |
| `/api/class-teacher/dashboard/stats/*` | GET | 班主任仪表盘统计 |

### 6.8 基础数据

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/semesters` | GET | 学期列表 |
| `/api/semesters` | POST | 创建学期 |
| `/api/grades` | GET | 年级列表 |
| `/api/grades` | POST | 创建年级 |
| `/api/classes` | GET | 班级列表 |
| `/api/classes` | POST | 创建班级 |

### 6.9 系统管理

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/backup/create` | POST | 创建备份 |
| `/api/backup/list` | GET | 备份列表 |
| `/api/backup/restore` | POST | 恢复备份 |
| `/api/backup/schedule` | GET/POST | 自动备份配置 |
| `/api/system-config` | GET | 系统设置 |
| `/api/system-config` | PUT | 更新设置 |
| `/api/operation-logs` | GET | 操作日志查询 |

## 7. 页面路由设计

### 7.1 公共页面
| 路由 | 页面 | 说明 |
|-----|------|------|
| `/login` | 登录页 | 用户登录 |

### 7.2 管理员端
| 路由 | 页面 | 说明 |
|-----|------|------|
| `/admin` | 仪表盘 | 数据统计概览 |
| `/admin/users` | 用户管理 | 用户列表和操作 |
| `/admin/students` | 学生管理 | 学生列表和操作 |
| `/admin/leaves` | 请假管理 | 请假记录和审核 |
| `/admin/leaves/pending` | 待审核 | 待审核请假列表 |
| `/admin/refunds` | 退费管理 | 退费清单和统计 |
| `/admin/semesters` | 学期管理 | 学期设置 |
| `/admin/grades` | 年级管理 | 年级设置 |
| `/admin/classes` | 班级管理 | 班级设置 |
| `/admin/settings` | 系统设置 | 系统配置 |
| `/admin/backup` | 数据备份 | 备份和恢复 |

### 7.3 教师端
| 路由 | 页面 | 说明 |
|-----|------|------|
| `/teacher` | 仪表盘 | 个人请假概览 |
| `/teacher/leaves` | 我的请假 | 请假记录列表 |
| `/teacher/leaves/new` | 申请请假 | 创建请假申请 |
| `/teacher/students` | 学生查询 | 查看学生信息 |

### 7.4 班主任端
| 路由 | 页面 | 说明 |
|-----|------|------|
| `/class-teacher` | 仪表盘 | 班级数据概览 |
| `/class-teacher/students` | 我的学生 | 本班学生列表 |
| `/class-teacher/leaves` | 班级请假 | 本班请假记录 |

## 8. 开发计划

### 8.1 开发阶段

#### 阶段一：项目初始化
- [ ] 创建 Next.js 项目
- [ ] 配置 TypeScript
- [ ] 配置 Tailwind CSS v4
- [ ] 安装 shadcn/ui
- [ ] 配置 SQLite 数据库
- [ ] 设置项目目录结构
- [ ] 编写数据库迁移脚本
- [ ] 准备初始数据

#### 阶段二：基础框架搭建
- [ ] 实现用户认证系统
- [ ] 创建布局组件
- [ ] 创建中间件（权限控制）
- [ ] 实现登录/登出页面
- [ ] 创建主布局框架

#### 阶段三：基础数据管理
- [ ] 学期管理模块
- [ ] 年级管理模块
- [ ] 班级管理模块
- [ ] 学生管理模块
- [ ] 用户管理模块

#### 阶段四：请假功能
- [ ] 请假申请功能
- [ ] 请假审核功能
- [ ] 请假记录查询
- [ ] 退费金额自动计算
- [ ] 营养餐学生限制逻辑

#### 阶段五：退费管理
- [ ] 退费统计汇总
- [ ] 退费清单生成
- [ ] 退费数据导出

#### 阶段六：导入导出
- [ ] Excel 导入功能
- [ ] Excel 导出功能
- [ ] 数据模板下载

#### 阶段七：系统管理
- [ ] 数据库备份
- [ ] 数据库恢复
- [ ] 系统配置
- [ ] 操作日志

#### 阶段八：测试与优化
- [ ] 功能测试
- [ ] 性能优化
- [ ] 安全检查
- [ ] 文档完善

### 8.2 关键文件清单

```
# 数据库相关
lib/db/schema.ts           # 数据库 Schema 定义
lib/db/index.ts            # 数据库连接和操作
lib/db/migrations/         # 数据库迁移文件

# API 服务层
lib/api/auth.ts            # 认证服务
lib/api/users.ts           # 用户服务
lib/api/students.ts        # 学生服务
lib/api/leaves.ts          # 请假服务
lib/api/refunds.ts         # 退费服务
lib/api/classes.ts         # 班级服务
lib/api/import.ts          # 导入服务
lib/api/export.ts          # 导出服务
lib/api/backup.ts          # 备份服务

# 类型定义
types/index.ts             # 通用类型
types/user.ts              # 用户类型
types/student.ts           # 学生类型
types/leave.ts             # 请假类型

# 工具函数
lib/utils/date.ts          # 日期工具
lib/utils/excel.ts         # Excel 工具
lib/utils/refund.ts        # 退费计算工具
lib/utils/validation.ts    # 验证工具

# 常量定义
lib/constants/roles.ts     # 角色常量
lib/constants/status.ts    # 状态常量

# 组件
components/layouts/DashboardLayout.tsx    # 管理后台布局
components/layouts/AuthLayout.tsx         # 认证页面布局
components/admin/UserTable.tsx            # 用户表格
components/admin/StudentTable.tsx         # 学生表格
components/admin/LeaveTable.tsx           # 请假表格
components/admin/LeaveReviewDialog.tsx    # 审核对话框
components/teacher/LeaveForm.tsx          # 请假表单
components/shared/DataTable.tsx           # 通用数据表格
```

## 9. 安全考虑

### 9.1 认证与授权
- 使用 JWT 或 Session 进行用户认证
- 密码使用 bcrypt 加密存储
- 实现基于角色的访问控制 (RBAC)
- API 接口权限验证中间件

### 9.2 数据安全
- SQL 参数化查询防止 SQL 注入
- 输入验证和清理
- XSS 防护
- CSRF 防护

### 9.3 敏感操作
- 敏感操作记录操作日志
- 数据备份前进行验证
- 删除操作使用软删除

## 10. 性能优化

### 10.1 数据库优化
- 合理使用索引
- 分页查询大数据集
- 使用数据库连接池

### 10.2 前端优化
- 使用 Next.js 服务端渲染
- 组件懒加载
- 图片优化使用 Next.js Image 组件
- 合理使用缓存

## 11. 测试策略

### 11.1 单元测试
- 核心业务逻辑函数
- 工具函数
- 数据验证函数

### 11.2 集成测试
- API 接口测试
- 数据库操作测试

### 11.3 E2E 测试
- 关键业务流程测试
- 用户登录流程
- 请假申请和审核流程

## 12. 部署说明

### 12.1 环境要求
- Node.js >= 18
- SQLite 3

### 12.2 环境变量
```env
# 数据库
DATABASE_PATH=./data/student_leave.db

# 会话密钥
SESSION_SECRET=your-secret-key

# 备份目录
BACKUP_DIR=./backups

# 上传文件大小限制
MAX_FILE_SIZE=10485760
```

### 12.3 构建与运行
```bash
# 安装依赖
npm install

# 运行开发环境
npm run dev

# 构建生产版本
npm run build

# 运行生产版本
npm start
```
